---
title: "Analysis Report"
author: "Gerda Lukosiute"
output: html_document
---

``` {r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## This is a scRNAseq data analysis of CRC tumor infiltrating cells (heavily focused on NK and ILC1).

``` {r packages, echo = TRUE}
setwd("/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC")
library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(DoubletFinder)
library(tidyverse)
library(SeuratData)
library(reshape2)
library(ggplot2)
library(metap)
library(clusterProfiler)
library(org.Mm.eg.db)
library(enrichplot)
library(cluster)
library(Nebulosa)
library(dplyr)
library(reshape2)
library(ggrepel)
library(enrichplot)
library(EnhancedVolcano)
library(DESeq2) 
```

## Initially I exclude sample 5, since it has insufficient data to contribute to the analysis efficiently. I will try to subsequently save it in a later chunck.

``` {r import data, echo = TRUE}
mtx_sample1 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag01_mm/Fionda-2024-R2_SampleTag01_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag01_mm/Fionda-2024-R2_SampleTag01_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag01_mm/Fionda-2024-R2_SampleTag01_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample2 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag02_mm/Fionda-2024-R2_SampleTag02_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag02_mm/Fionda-2024-R2_SampleTag02_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag02_mm/Fionda-2024-R2_SampleTag02_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample3 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag03_mm/Fionda-2024-R2_SampleTag03_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag03_mm/Fionda-2024-R2_SampleTag03_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag03_mm/Fionda-2024-R2_SampleTag03_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample4 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag04_mm/Fionda-2024-R2_SampleTag04_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag04_mm/Fionda-2024-R2_SampleTag04_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag04_mm/Fionda-2024-R2_SampleTag04_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

#mtx_sample5 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag05_mm/Fionda-2024-R2_SampleTag05_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag05_mm/Fionda-2024-R2_SampleTag05_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag05_mm/Fionda-2024-R2_SampleTag05_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample6 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag06_mm/Fionda-2024-R2_SampleTag06_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag06_mm/Fionda-2024-R2_SampleTag06_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag06_mm/Fionda-2024-R2_SampleTag06_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample7 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag07_mm/Fionda-2024-R2_SampleTag07_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag07_mm/Fionda-2024-R2_SampleTag07_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag07_mm/Fionda-2024-R2_SampleTag07_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")

mtx_sample8 <- ReadMtx(mtx = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag08_mm/Fionda-2024-R2_SampleTag08_mm_RSEC_MolsPerCell_MEX/matrix.mtx.gz", features = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag08_mm/Fionda-2024-R2_SampleTag08_mm_RSEC_MolsPerCell_MEX/features.tsv.gz", cells = "/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/mCRC_ILC/Fionda-2024-R2_SampleTag08_mm/Fionda-2024-R2_SampleTag08_mm_RSEC_MolsPerCell_MEX/barcodes.tsv.gz")
```

## Next, I create the Seurat objects for each sample.

``` {r create objects, echo = TRUE}
seurat_s1 <- CreateSeuratObject(counts = mtx_sample1, project = "Sample_1", min.cells = 3, min.features = 200)
seurat_s2 <- CreateSeuratObject(counts = mtx_sample2, project = "Sample_2", min.cells = 3, min.features = 200)
seurat_s3 <- CreateSeuratObject(counts = mtx_sample3, project = "Sample_3", min.cells = 3, min.features = 200)
seurat_s4 <- CreateSeuratObject(counts = mtx_sample4, project = "Sample_4", min.cells = 3, min.features = 200)
#seurat_s5 <- CreateSeuratObject(counts = mtx_sample5, project = "Sample_5", min.cells = 3, min.features = 200)
seurat_s6 <- CreateSeuratObject(counts = mtx_sample6, project = "Sample_6", min.cells = 3, min.features = 200)
seurat_s7 <- CreateSeuratObject(counts = mtx_sample7, project = "Sample_7", min.cells = 3, min.features = 200)
seurat_s8 <- CreateSeuratObject(counts = mtx_sample8, project = "Sample_8", min.cells = 3, min.features = 200)
```

## Subsequently, I perform some of the steps of the Seurat analysis as described in the documentation for Seurat project (https://satijalab.org/seurat/articles/integration_introduction). The remaining steps are completed after merging the samples.

### Sample 1

``` {r sample 1, echo = TRUE}
#Quality control
seurat_s1[["percent.mt"]] <- PercentageFeatureSet(seurat_s1, pattern = "^mt-") 
#View(seurat_s1@meta.data)

VlnPlot(seurat_s1, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s1, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s1, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s1, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s1.filtered <- subset(seurat_s1, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s1.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s1.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s1.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

#Normalization
s1_normalized <- NormalizeData(object = seurat_s1.filtered)

#Integration
s1_integrated <- FindVariableFeatures(object = s1_normalized)
top10 <- head(VariableFeatures(s1_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s1_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s1_scaled <- ScaleData(object = s1_integrated)

#Linear dimensionality reduction
s1_reduced <- RunPCA(object = s1_scaled) 
VizDimLoadings(s1_reduced, dims = 1:2, reduction = "pca")
DimPlot(s1_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s1_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s1_reduced)

#Clustering
s1_neighboors <- FindNeighbors(object = s1_reduced, dims = 1:20)
s1_clusters <- FindClusters(object = s1_neighboors)
head(Idents(s1_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s1_umap <- RunUMAP(object = s1_clusters, dims = 1:20)
DimPlot(s1_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s1 <- paramSweep(s1_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s1 <- summarizeSweep(sweep.res.list_s1, GT = FALSE)
bcmvn_s1 <- find.pK(sweep.stats_s1)

ggplot(bcmvn_s1, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.29 max
pK <- bcmvn_s1[bcmvn_s1$BCmetric == max(bcmvn_s1$BCmetric), "pK"]
pK <- as.numeric(as.character(pK)) 
pK

#Homotypic doublet proportion estimate
annotations <- s1_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s1_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s1_finalized <- doubletFinder(s1_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s1_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.29_67")
table(s1_finalized@meta.data$DF.classifications_0.25_0.29_67)

s1_finalized <- subset(s1_finalized, subset = DF.classifications_0.25_0.29_67 == "Singlet")
table(s1_finalized@meta.data$DF.classifications_0.25_0.29_67)
DimPlot(s1_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.29_67")
```

### Sample 2

``` {r sample 2, echo = TRUE}
#Quality control
seurat_s2[["percent.mt"]] <- PercentageFeatureSet(seurat_s2, pattern = "^mt-") 
#View(seurat_s2@meta.data)

VlnPlot(seurat_s2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s2, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s2, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s2, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s2.filtered <- subset(seurat_s2, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s2.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s2.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s2.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

#Normalization
s2_normalized <- NormalizeData(object = seurat_s2.filtered)

#Integration
s2_integrated <- FindVariableFeatures(object = s2_normalized)
top10 <- head(VariableFeatures(s2_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s2_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s2_scaled <- ScaleData(object = s2_integrated)

#Linear dimensionality reduction
s2_reduced <- RunPCA(object = s2_scaled) 
VizDimLoadings(s2_reduced, dims = 1:2, reduction = "pca")
DimPlot(s2_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s2_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s2_reduced)

#Clustering
s2_neighboors <- FindNeighbors(object = s2_reduced, dims = 1:20)
s2_clusters <- FindClusters(object = s2_neighboors)
head(Idents(s2_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s2_umap <- RunUMAP(object = s2_clusters, dims = 1:20)
DimPlot(s2_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s2 <- paramSweep(s2_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s2 <- summarizeSweep(sweep.res.list_s2, GT = FALSE)
bcmvn_s2 <- find.pK(sweep.stats_s2)

ggplot(bcmvn_s2, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.11 max
pK <- bcmvn_s2[bcmvn_s2$BCmetric == max(bcmvn_s2$BCmetric), "pK"]
pK <- as.numeric(as.character(pK)) 
pK

#Homotypic doublet proportion estimate
annotations <- s2_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s2_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s2_finalized <- doubletFinder(s2_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s2_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.11_34")
table(s2_finalized@meta.data$DF.classifications_0.25_0.11_34)

s2_finalized <- subset(s2_finalized, subset = DF.classifications_0.25_0.11_34 == "Singlet")
table(s2_finalized@meta.data$DF.classifications_0.25_0.11_34)
DimPlot(s2_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.11_34")
```

### Sample 3 

``` {r sample 3, echo = TRUE} 
#Quality control
seurat_s3[["percent.mt"]] <- PercentageFeatureSet(seurat_s3, pattern = "^mt-") 
#View(seurat_s3@meta.data)

VlnPlot(seurat_s3, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s3, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s3, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s3, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s3.filtered <- subset(seurat_s3, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s3.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s3.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s3.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

#Normalization
s3_normalized <- NormalizeData(object = seurat_s3.filtered)

#Integration
s3_integrated <- FindVariableFeatures(object = s3_normalized)
top10 <- head(VariableFeatures(s3_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s3_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s3_scaled <- ScaleData(object = s3_integrated)

#Linear dimensionality reduction
s3_reduced <- RunPCA(object = s3_scaled) 
VizDimLoadings(s3_reduced, dims = 1:2, reduction = "pca")
DimPlot(s3_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s3_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s3_reduced)

#Clustering
s3_neighboors <- FindNeighbors(object = s3_reduced, dims = 1:20)
s3_clusters <- FindClusters(object = s3_neighboors)
head(Idents(s3_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s3_umap <- RunUMAP(object = s3_clusters, dims = 1:20)
DimPlot(s3_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s3 <- paramSweep(s3_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s3 <- summarizeSweep(sweep.res.list_s3, GT = FALSE)
bcmvn_s3 <- find.pK(sweep.stats_s3)

ggplot(bcmvn_s3, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.25 max
pK <- bcmvn_s3[bcmvn_s3$BCmetric == max(bcmvn_s3$BCmetric), "pK"]
pK <- as.numeric(as.character(pK))
pK

#Homotypic doublet proportion estimate
annotations <- s3_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s3_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s3_finalized <- doubletFinder(s3_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s3_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.25_31")
table(s3_finalized@meta.data$DF.classifications_0.25_0.25_31)

s3_finalized <- subset(s3_finalized, subset = DF.classifications_0.25_0.25_31 == "Singlet")
table(s3_finalized@meta.data$DF.classifications_0.25_0.25_31)
DimPlot(s3_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.25_31")
```

### Sample 4

``` {r sample 4, echo = TRUE}
#Quality control
seurat_s4[["percent.mt"]] <- PercentageFeatureSet(seurat_s4, pattern = "^mt-") 
#View(seurat_s4@meta.data)

VlnPlot(seurat_s4, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s4, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s4, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s4, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s4.filtered <- subset(seurat_s4, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s4.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s4.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s4.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

#Normalization
s4_normalized <- NormalizeData(object = seurat_s4.filtered)

#Integration
s4_integrated <- FindVariableFeatures(object = s4_normalized)
top10 <- head(VariableFeatures(s4_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s4_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s4_scaled <- ScaleData(object = s4_integrated)

#Linear dimensionality reduction
s4_reduced <- RunPCA(object = s4_scaled) 
VizDimLoadings(s4_reduced, dims = 1:2, reduction = "pca")
DimPlot(s4_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s4_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s4_reduced)

#Clustering
s4_neighboors <- FindNeighbors(object = s4_reduced, dims = 1:20)
s4_clusters <- FindClusters(object = s4_neighboors)
head(Idents(s4_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s4_umap <- RunUMAP(object = s4_clusters, dims = 1:20)
DimPlot(s4_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s4 <- paramSweep(s4_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s4 <- summarizeSweep(sweep.res.list_s4, GT = FALSE)
bcmvn_s4 <- find.pK(sweep.stats_s4)

ggplot(bcmvn_s4, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.3 max
pK <- bcmvn_s4[bcmvn_s4$BCmetric == max(bcmvn_s4$BCmetric), "pK"]
pK <- as.numeric(as.character(pK))
pK

#Homotypic doublet proportion estimate
annotations <- s4_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s4_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s4_finalized <- doubletFinder(s4_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s4_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.3_3")
table(s4_finalized@meta.data$DF.classifications_0.25_0.3_3)

s4_finalized <- subset(s4_finalized, subset = DF.classifications_0.25_0.3_3 == "Singlet")
table(s4_finalized@meta.data$DF.classifications_0.25_0.3_3)
DimPlot(s4_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.3_3")
```

### Sample 5 (left for later)

``` {r sample 5, echo = TRUE}
#Quality control
#seurat_s5[["percent.mt"]] <- PercentageFeatureSet(seurat_s5, pattern = "^mt-") 
#View(seurat_s5@meta.data)

#VlnPlot(seurat_s5, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

#FeatureScatter(seurat_s5, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
#FeatureScatter(seurat_s5, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
#FeatureScatter(seurat_s5, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

#seurat_s5.filtered <- subset(seurat_s5, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10) #maybe lower percent.mt?

#FeatureScatter(seurat_s5.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
#FeatureScatter(seurat_s5.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
#FeatureScatter(seurat_s5.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

#VlnPlot(seurat_s5.filtered, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

#Normalization
#s5_normalized <- NormalizeData(object = seurat_s5.filtered)

#Integration
#s5_integrated <- FindVariableFeatures(object = s5_normalized)
#top10 <- head(VariableFeatures(s5_integrated), 10)
#top10
#plot1 <- VariableFeaturePlot(s5_integrated)
#plot1
#plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
#plot2

#Scaling
#s5_scaled <- ScaleData(object = s5_integrated)

#Linear dimensionality reduction
#s5_reduced <- RunPCA(object = s5_scaled, npcs = 10) 
#VizDimLoadings(s5_reduced, dims = 1:2, reduction = "pca")
#DimPlot(s5_reduced, reduction = "pca") + NoLegend()
#DimHeatmap(s5_reduced, dims = 1:10, cells = 500, balanced = TRUE)
#ElbowPlot(s5_reduced)

#Clustering
#s5_neighboors <- FindNeighbors(object = s5_reduced, dims = 1:10)
#s5_clusters <- FindClusters(object = s5_neighboors)
#head(Idents(s5_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
#s5_umap <- RunUMAP(object = s5_clusters, dims = 1:10, n.neighbors = 5)
#DimPlot(s5_umap, reduction = "umap")

#Doublet finder; UNAVAILABLE FOR THIS SAMPLE; RUN DOWNSTREAM ANALYSIS WITH AND WITHOUT S5 TO SEE THE EFFECT
#pK identification (no ground-truth)
#sweep.res.list_s5 <- paramSweep(s5_umap, PCs = 1:10, sct = FALSE) #very low cell count, gives error 
#sweep.stats_s5 <- summarizeSweep(sweep.res.list_s5, GT = FALSE)
#bcmvn_s5 <- find.pK(sweep.stats_s5)

#ggplot(bcmvn_s5, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.3 max
#pK <- bcmvn_s5[bcmvn_s4$BCmetric == max(bcmvn_s5$BCmetric), "pK"]
#pK <- as.numeric(as.character(pK))
#pK

#Homotypic doublet proportion estimate
#annotations <- s5_umap@meta.data$seurat_clusters
#homotypic.prop <- modelHomotypic(annotations)
#nExp_poi <- round(0.05*nrow(s5_umap@meta.data)) ##in project description
#nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
#nExp_poi.adj #expected number of doublets

#DoubletFinder
#s5_finalized <- doubletFinder(s5_umap,
                              #PCs = 1:20,
                              #pK = pK,
                              #nExp = nExp_poi.adj,
                              #reuse.pANN = FALSE, sct = FALSE)
#DimPlot(s5_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.3_3")
#table(s5_finalized@meta.data$DF.classifications_0.25_0.3_3)

#s5_finalized <- subset(s5_finalized, subset = DF.classifications_0.25_0.3_3 == "Singlet")
#table(s5_finalized@meta.data$DF.classifications_0.25_0.3_3)
#DimPlot(s5_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.3_3")
```

### Sample 6

``` {r sample 6, echo = TRUE}
#Quality control
seurat_s6[["percent.mt"]] <- PercentageFeatureSet(seurat_s6, pattern = "^mt-") 
#View(seurat_s6@meta.data)

VlnPlot(seurat_s6, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s6, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s6, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s6, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s6.filtered <- subset(seurat_s6, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s6.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s6.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s6.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

VlnPlot(seurat_s6.filtered, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

#Normalization
s6_normalized <- NormalizeData(object = seurat_s6.filtered)

#Integration
s6_integrated <- FindVariableFeatures(object = s6_normalized)
top10 <- head(VariableFeatures(s6_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s6_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s6_scaled <- ScaleData(object = s6_integrated)

#Linear dimensionality reduction
s6_reduced <- RunPCA(object = s6_scaled) 
VizDimLoadings(s6_reduced, dims = 1:2, reduction = "pca")
DimPlot(s6_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s6_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s6_reduced)

#Clustering
s6_neighboors <- FindNeighbors(object = s6_reduced, dims = 1:20)
s6_clusters <- FindClusters(object = s6_neighboors)
head(Idents(s6_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s6_umap <- RunUMAP(object = s6_clusters, dims = 1:20)
DimPlot(s6_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s6 <- paramSweep(s6_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s6 <- summarizeSweep(sweep.res.list_s6, GT = FALSE)
bcmvn_s6 <- find.pK(sweep.stats_s6)

ggplot(bcmvn_s6, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.2
pK <- bcmvn_s6[bcmvn_s6$BCmetric == max(bcmvn_s6$BCmetric), "pK"]
pK <- as.numeric(as.character(pK))
pK

#Homotypic doublet proportion estimate
annotations <- s6_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s6_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s6_finalized <- doubletFinder(s6_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s6_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.2_37")
table(s6_finalized@meta.data$DF.classifications_0.25_0.2_37)

s6_finalized <- subset(s6_finalized, subset = DF.classifications_0.25_0.2_37 == "Singlet")
table(s6_finalized@meta.data$DF.classifications_0.25_0.2_37)
DimPlot(s6_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.2_37")
```

### Sample 7

``` {r sample 7, echo = TRUE}
#Quality control
seurat_s7[["percent.mt"]] <- PercentageFeatureSet(seurat_s7, pattern = "^mt-") 
#View(seurat_s7@meta.data)

VlnPlot(seurat_s7, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s7, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s7, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s7, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s7.filtered <- subset(seurat_s7, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s7.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s7.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s7.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

VlnPlot(seurat_s7.filtered, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

#Normalization
s7_normalized <- NormalizeData(object = seurat_s7.filtered)

#Integration
s7_integrated <- FindVariableFeatures(object = s7_normalized)
top10 <- head(VariableFeatures(s7_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s7_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s7_scaled <- ScaleData(object = s7_integrated)

#Linear dimensionality reduction
s7_reduced <- RunPCA(object = s7_scaled) 
VizDimLoadings(s7_reduced, dims = 1:2, reduction = "pca")
DimPlot(s7_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s7_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s7_reduced)

#Clustering
s7_neighboors <- FindNeighbors(object = s7_reduced, dims = 1:20)
s7_clusters <- FindClusters(object = s7_neighboors)
head(Idents(s7_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s7_umap <- RunUMAP(object = s7_clusters, dims = 1:20)
DimPlot(s7_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s7 <- paramSweep(s7_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s7 <- summarizeSweep(sweep.res.list_s7, GT = FALSE)
bcmvn_s7 <- find.pK(sweep.stats_s7)

ggplot(bcmvn_s7, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.16
pK <- bcmvn_s7[bcmvn_s7$BCmetric == max(bcmvn_s7$BCmetric), "pK"]
pK <- as.numeric(as.character(pK))
pK

#Homotypic doublet proportion estimate
annotations <- s7_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s7_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s7_finalized <- doubletFinder(s7_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s7_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.16_9")
table(s7_finalized@meta.data$DF.classifications_0.25_0.16_9)

s7_finalized <- subset(s7_finalized, subset = DF.classifications_0.25_0.16_9 == "Singlet")
table(s7_finalized@meta.data$DF.classifications_0.25_0.16_9)
DimPlot(s7_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.16_9")
```

### Sample 8

``` {r sample 8, echo = TRUE}
#Quality control
seurat_s8[["percent.mt"]] <- PercentageFeatureSet(seurat_s8, pattern = "^mt-") 
#View(seurat_s8@meta.data)

VlnPlot(seurat_s8, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

FeatureScatter(seurat_s8, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s8, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s8, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 

seurat_s8.filtered <- subset(seurat_s8, subset = nFeature_RNA >= 200 & nFeature_RNA <= 4000 & percent.mt < 10)

FeatureScatter(seurat_s8.filtered, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") + geom_smooth(method = 'lm')
FeatureScatter(seurat_s8.filtered, feature1 = "nCount_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm') 
FeatureScatter(seurat_s8.filtered, feature1 = "nFeature_RNA", feature2 = "percent.mt") + geom_smooth(method = 'lm')

VlnPlot(seurat_s8.filtered, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

#Normalization
s8_normalized <- NormalizeData(object = seurat_s8.filtered)

#VFs
s8_integrated <- FindVariableFeatures(object = s8_normalized)
top10 <- head(VariableFeatures(s8_integrated), 10)
top10
plot1 <- VariableFeaturePlot(s8_integrated)
plot1
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) #labeled(extra swag)
plot2

#Scaling
s8_scaled <- ScaleData(object = s8_integrated)

#Linear dimensionality reduction
s8_reduced <- RunPCA(object = s8_scaled) 
VizDimLoadings(s8_reduced, dims = 1:2, reduction = "pca")
DimPlot(s8_reduced, reduction = "pca") + NoLegend()
DimHeatmap(s8_reduced, dims = 1:20, cells = 500, balanced = TRUE)
ElbowPlot(s8_reduced)

#Clustering
s8_neighboors <- FindNeighbors(object = s8_reduced, dims = 1:20)
s8_clusters <- FindClusters(object = s8_neighboors)
head(Idents(s8_clusters), 5) #cluster IDs 1st 5 cells

#UMAP
s8_umap <- RunUMAP(object = s8_clusters, dims = 1:20)
DimPlot(s8_umap, reduction = "umap")

#Doublet finder
#pK identification (no ground-truth)
sweep.res.list_s8 <- paramSweep(s8_umap, PCs = 1:20, sct = FALSE)
sweep.stats_s8 <- summarizeSweep(sweep.res.list_s8, GT = FALSE)
bcmvn_s8 <- find.pK(sweep.stats_s8)

ggplot(bcmvn_s8, aes(pK, BCmetric, group = 1)) + geom_point() + geom_line()
#0.15
pK <- bcmvn_s8[bcmvn_s8$BCmetric == max(bcmvn_s8$BCmetric), "pK"]
pK <- as.numeric(as.character(pK))
pK

#Homotypic doublet proportion estimate
annotations <- s8_umap@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp_poi <- round(0.05*nrow(s8_umap@meta.data)) ##in project description
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))
nExp_poi.adj #expected number of doublets

#DoubletFinder
s8_finalized <- doubletFinder(s8_umap,
                              PCs = 1:20,
                              pK = pK,
                              nExp = nExp_poi.adj,
                              reuse.pANN = FALSE, sct = FALSE)
DimPlot(s8_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.15_24")
table(s8_finalized@meta.data$DF.classifications_0.25_0.15_24)

s8_finalized <- subset(s8_finalized, subset = DF.classifications_0.25_0.15_24 == "Singlet")
table(s8_finalized@meta.data$DF.classifications_0.25_0.15_24)
DimPlot(s8_finalized, reduction = 'umap', group.by = "DF.classifications_0.25_0.15_24")
```

## Next, I merge the samples into a single object for easier downstream analysis (skipping sample 5 for now).

``` {r merge object, echo = TRUE}
samples <- list(s2_finalized, s3_finalized, s4_finalized, s6_finalized, s7_finalized, s8_finalized) #skipping s5
merged_object <- merge(s1_finalized, y = samples, add.cell.ids = c("s1", "s2", "s3", "s4", "s6", "s7", "s8"))
#merged_object[["RNA"]] <- split(merged_object[["RNA"]], f = merged_object$orig.ident) #not necessary to include scale.data since integrating downstream it's recalculated
```

## Proceeding with the steps in the Seurat documentation on integration.

``` {r merged downstream, echo = TRUE} 
merged_object <- NormalizeData(merged_object)
merged_object <- FindVariableFeatures(merged_object)
merged_object <- ScaleData(merged_object)
merged_object <- RunPCA(merged_object)
merged_object <- FindNeighbors(merged_object, dims = 1:20, reduction = "pca")
merged_object <- FindClusters(merged_object, resolution = 2, cluster.name = "unintegrated_clusters")
merged_object <- RunUMAP(merged_object, dims = 1:20, reduction = "pca", reduction.name = "umap.unintegrated")
DimPlot(merged_object, reduction ="umap.unintegrated", group.by = c("orig.ident", "seurat_clusters"))
#Integration -> to account for sample differences
merged_object <- IntegrateLayers(object = merged_object, method = CCAIntegration, orig.reduction = "pca", new.reduction = "integrated.cca", verbose = FALSE)

merged_object <- JoinLayers(merged_object)
head(merged_object)
tail(merged_object)

merged_object <- FindNeighbors(merged_object, reduction = "integrated.cca", dims = 1:20)
merged_object <- FindClusters(merged_object, resolution = 0.5, cluster.name = "integrated_clusters") #keep lower; increase based on cond
merged_object <- RunUMAP(merged_object, dims = 1:20, reduction = "integrated.cca")
DimPlot(merged_object, reduction = "umap", group.by = c("orig.ident", "seurat_clusters")) 
DimPlot(merged_object, reduction = "umap", split.by = "orig.ident")
```

## This is a plot regarding the percentage of samples in each cluster.

``` {r percent per cluster, echo = TRUE}
cell_counts <- table(merged_object$orig.ident, merged_object$integrated_clusters)
cell_perc <- prop.table(cell_counts, margin = 1)*100
percentages_df <- melt(cell_perc, varnames = c("Sample", "Cluster"), value.name = "Percentage")

ggplot(percentages_df, aes(x = as.factor(Cluster), y = Percentage, fill = Sample)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Percentage of cells per sample in each cluster",
       x = "Cluster",
       y = "Percentage of Cells") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Finding all markers

``` {r type annotation, echo = TRUE}
#Finding ALL MARKERS for all clusters
all_markers <- FindAllMarkers(merged_object, only.pos = T)
top_markers <- all_markers %>%
  group_by(cluster) %>%
  slice_max(order_by = avg_log2FC, n = 20)
print(top_markers, n = 200)
```

## Conserved markers by clusters

### Cluster 0

``` {r cluster 0, echo = TRUE}
markers_c0 <- FindConservedMarkers(merged_object, ident.1 = 0, grouping.var = "orig.ident")
head(markers_c0)
FeaturePlot(merged_object, features = c("Gzma", "Gzmb", "Tmsb4x", "Prf1", "Actb", "Emb"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 1

``` {r cluster 1, echo = TRUE} 
markers_c1 <- FindConservedMarkers(merged_object, ident.1 = 1, grouping.var = "orig.ident")
head(markers_c1)
FeaturePlot(merged_object, features = c("Ccr2", "Ccl5", "Gzmb", "Cd7", "Rap1b", "Ctla2a"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 2 

``` {r cluster 2, echo = TRUE}
markers_c2 <- FindConservedMarkers(merged_object, ident.1 = 2, grouping.var = "orig.ident")
head(markers_c2)
FeaturePlot(merged_object, features = c("Tmsb4x", "Pmepa1", "Cfl1", "Actb", "Ncr1", "Pfn1"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 3

``` {r cluster 3, echo = TRUE}
markers_c3 <- FindConservedMarkers(merged_object, ident.1 = 3, grouping.var = "orig.ident")
head(markers_c3)
FeaturePlot(merged_object, features = c("Nr4a1", "Pim1", "Nr4a3", "Nfkbiz", "Nfkbid", "Nfkbia"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 4

``` {r cluster 4, echo = TRUE}
markers_c4 <- FindConservedMarkers(merged_object, ident.1 = 4, grouping.var = "orig.ident")
head(markers_c4)
FeaturePlot(merged_object, features = c("Tmem176b", "Tmem176a", "Cxcr6", "Il7r", "Ckb", "Krt83"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 5

``` {r cluster 5, echo = TRUE}
markers_c5 <- FindConservedMarkers(merged_object, ident.1 = 5, grouping.var = "orig.ident")
head(markers_c5)
FeaturePlot(merged_object, features = c("Cd3e", "Cd3g", "Trgc2", "Cd3d", "Trgc1", "Dpp4"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 6

``` {r cluster 6, echo = TRUE}
markers_c6 <- FindConservedMarkers(merged_object, ident.1 = 6, grouping.var = "orig.ident")
head(markers_c6)
FeaturePlot(merged_object, features = c("Oas3", "Mx1", "Rsad2", "Ifit1", "Slfn5", "Ifi204"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 7

``` {r cluster 7, echo = TRUE}
markers_c7 <- FindConservedMarkers(merged_object, ident.1 = 7, grouping.var = "orig.ident")
head(markers_c7)
FeaturePlot(merged_object, features = c("Cd8b1", "Cd8a", "Themis", "Pdcd1", "Fam169b", "Havcr2"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 8

``` {r cluster 8, echo = TRUE}
markers_c8 <- FindConservedMarkers(merged_object, ident.1 = 8, grouping.var = "orig.ident")
head(markers_c8)
FeaturePlot(merged_object, features = c("Pclaf", "E2f1", "Kntc1", "Nuf2", "Spc24", "Cdc6"), min.cutoff = 'q10', reduction = "umap")
```

### Cluster 9

``` {r cluster 9, echo = TRUE}
markers_c9 <- FindConservedMarkers(merged_object, ident.1 = 9, grouping.var = "orig.ident")
head(markers_c9)
FeaturePlot(merged_object, features = c("Cd40", "Clec4d", "Sirpa", "Pirb", "Tgfbi", "Il1b"), min.cutoff = 'q10', reduction = "umap")
```

# Reference based cell type annotation using cell typist (refer to the celltypist_run.py script in the repo) 

``` {r annotation, echo = TRUE}
expression_matrix <- GetAssayData(merged_object, assay = "RNA", slot = "data")
dense_matrix <- as.matrix(expression_matrix)
expression_df <- as.data.frame(t(dense_matrix))
expression_df$cell_id <- rownames(expression_df)
expression_df <- expression_df[, c(ncol(expression_df), 1:(ncol(expression_df) - 1))]
write.csv(expression_df, file = "seurat_expression.csv", row.names = FALSE, quote = FALSE)

predictions <- read.csv("/Users/gerdalukosiute/Downloads/Thesis/analysis_mCRC/predicted_labels.csv")
head(predictions)
rownames(predictions) <- predictions$cell_id
merged_object <- AddMetaData(merged_object, metadata = predictions$predicted_label, col.name = "celltypist_labels")
table(merged_object@meta.data$celltypist_labels)
```

# Initial NK and ILC1 subset

``` {r subset1, echo = TRUE}
FeaturePlot(merged_object, features = c("Cd3e", "Cd3d", "Tbx21", "Eomes", "Cd8b1", "Nkg7", "Gzmb"), min.cutoff = 'q10', reduction = "umap")

NK_and_ILC1 <- subset(merged_object, seurat_clusters %in% c(0, 1, 2, 3, 4, 6)) #both
NK_and_ILC1 <- NormalizeData(NK_and_ILC1)
NK_and_ILC1 <- FindVariableFeatures(NK_and_ILC1)
NK_and_ILC1 <- ScaleData(NK_and_ILC1, features = rownames(NK_and_ILC1))
NK_and_ILC1 <- RunPCA(NK_and_ILC1)
NK_and_ILC1 <- FindNeighbors(NK_and_ILC1, dims = 1:20)
NK_and_ILC1 <- FindClusters(NK_and_ILC1, resolution = 0.5, cluster.name = "NK_ILC1_clusters")  # try a few
NK_and_ILC1 <- RunUMAP(NK_and_ILC1, dims = 1:20)
DimPlot(NK_and_ILC1, reduction = "umap", group.by = "NK_ILC1_clusters")

# other
NK <- subset(merged_object, seurat_clusters %in% c(0, 1, 2, 3, 6)) #only NK

ILC1 <- subset(merged_object, seurat_clusters %in% c(4)) #only ILC1
```

# Assigning m95/96 organoids
## m95 -> 4 mutations (Apc, Kras, P53, Smad4)
## m96 -> 3 mutations (Apc, Kras, P53)

```{r organoids, echo=TRUE} 
# organoids
NK_and_ILC1$organoid <- ifelse(
  grepl("^s[1-4]_", colnames(NK_and_ILC1)), "m95", 
  ifelse(grepl("^s[6-8]_", colnames(NK_and_ILC1)), "m96", NA)
)

simple_shared <- table(NK_and_ILC1$organoid)
simple_shared

Idents(NK_and_ILC1) <- "organoid" 

# VISUALIZATION
DimPlot(NK_and_ILC1, reduction = "umap", split.by = "organoid", group.by = "NK_ILC1_clusters") + ggtitle("NK and ILC1 Clusters Split by Organoid")

shared_table <- table(NK_and_ILC1$NK_ILC1_clusters, NK_and_ILC1$organoid)
shared_table
m95_col <- shared_table[,"m95"] 
m96_col <- shared_table[,"m96"] 

m_95 <- data.frame(m95_col)
m95 <- rownames(m_95)
ggplot(m_95, aes(x="", y=m_95[,1], fill = m95)) + geom_bar(stat = "identity", width = 1, color = "white") + coord_polar("y", start = 0) + theme_void() 

m_96 <- data.frame(m96_col)
m96 <- rownames(m_96)
ggplot(m_96, aes(x="", y=m_96[,1], fill = m96)) + geom_bar(stat = "identity", width = 1, color = "white") + coord_polar("y", start = 0) + theme_void() 

counts_df <- melt(shared_table, varnames = c("Cluster", "Organoid"), value.name = "Count")

ggplot(counts_df, aes(x = as.factor(Cluster), y = Count, fill = Organoid)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Cell Count per Cluster in Each Organoid",
       x = "Cluster",
       y = "Cell Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# STATISTICAL SIGNIFICANCE
# tests cluster count identity differences between samples  (not normalized)
chisq.test(shared_table)  

# for small sample sizes:
fisher.test(shared_table, simulate.p.value = TRUE, B = 10000)

## SMALL P VALUES; INDICATE CLUSTER DISTRIBUTIONS DIFFER SIGNIFICANTLY BETWEEN M95/M96.

# tests whether proportion of cells in each cluster differs significantly between orgs
# each cluster individually using proportion test
for (i in 1:nrow(shared_table)) {
  cat("Cluster", rownames(shared_table)[i], "\n")
  print(prop.test(shared_table[i,], colSums(shared_table)))
}
# 0 -> < 0.05, but rlly close; likely more represented in m95
# 1 -> < 0.05, also likely more represented in m95
# 2 -> insignificant
# 3 -> < 0.05, also rlly close; significantly over-represented in m95
# 4 -> < 0.05, significantly over-represented in m96
# 5 -> insignificant

# per sample (not per organoid) comparison; avoids pseudoreplication
cluster_props <- NK_and_ILC1@meta.data %>%
  group_by(orig.ident, NK_ILC1_clusters) %>%
  summarise(count = n()) %>%
  group_by(orig.ident) %>%
  mutate(prop = count / sum(count))
cluster_props

# VISUALIZATION
cluster_props$organoid <- case_when(
  cluster_props$orig.ident %in% c("Sample_1", "Sample_2", "Sample_3", "Sample_4") ~ "m95",
  cluster_props$orig.ident %in% c("Sample_6", "Sample_7", "Sample_8") ~ "m96",
  TRUE ~ NA_character_
)

# Boxplot of proportions
ggplot(cluster_props, aes(x = NK_ILC1_clusters, y = prop, fill = organoid)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.7) +
  labs(title = "Cluster Proportions per Sample by Organoid",
       x = "Cluster",
       y = "Proportion") +
  theme_minimal()

heat_df <- dcast(cluster_props, orig.ident + organoid ~ NK_ILC1_clusters, value.var = "prop")

heat_df[is.na(heat_df)] <- 0 # replace na w 0
rownames(heat_df) <- heat_df$orig.ident
heat_data <- as.matrix(heat_df[, -(1:2)])  # remove sample and org columns

# annotation with matching rownames
annotation_row <- data.frame(Organoid = heat_df$organoid)
rownames(annotation_row) <- heat_df$orig.ident  # must match rownames of heat_data

pheatmap::pheatmap(heat_data, 
                   cluster_rows = TRUE, 
                   cluster_cols = TRUE,
                   annotation_row = annotation_row,
                   main = "Cluster Proportion Heatmap")

# normalized cluster props
prop_df <- as.data.frame(prop.table(shared_table, margin = 2))  # column-normalized
colnames(prop_df) <- c("Cluster", "Organoid", "Proportion")

ggplot(prop_df, aes(x = Cluster, y = Proportion, fill = Organoid)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Normalized Cluster Proportions by Organoid",
       y = "Proportion", x = "Cluster") +
  theme_minimal()

# For comparison between organoids (DE) use merged object with organoidid as metadata col (merged_object$organoid) -> allows comparisons while correcting sample effects
```

# Maturation/Exhaustion

```{r DEA, echo = TRUE}
# general subset markers wrt other cells; add organoid; fc <= 0.2; DESeq2
NK_and_ILC1_markers <- FindAllMarkers(NK_and_ILC1, min.pct = 0.25, logfc.threshold = 0.2, group.by = "NK_ILC1_clusters")
head(NK_and_ILC1_markers)

# sub
NK_and_ILC1_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 0.2) %>%
    slice_head(n = 10) %>%
    ungroup() -> top10pos

NK_and_ILC1_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC < -0.2) %>%
    slice_head(n = 10) %>%
    ungroup() -> top10neg

DoHeatmap(NK_and_ILC1, features = top10pos$gene, group.by = "NK_ILC1_clusters")
DoHeatmap(NK_and_ILC1, features = top10neg$gene, group.by = "NK_ILC1_clusters")

# maturation
maturation_genes <- c("Itgam", "Klrg1", "Cd27") 
FeaturePlot(NK_and_ILC1, features = maturation_genes, min.cutoff = 'q10', reduction = "umap", split.by = "organoid")
VlnPlot(NK_and_ILC1, features = maturation_genes, group.by = "NK_ILC1_clusters", split.by = "organoid", pt.size = 0, cols = c("lightblue", "pink")) 
DotPlot(NK_and_ILC1, features = maturation_genes, group.by = "NK_ILC1_clusters", split.by = "organoid", cols = c("lightblue", "pink")) + RotatedAxis()
RidgePlot(NK_and_ILC1, features = maturation_genes, ncol = 3, group.by = "NK_ILC1_clusters") 
DoHeatmap(NK_and_ILC1, features = maturation_genes, size = 3) 
FeatureScatter(NK_and_ILC1, feature1 = "Klrg1", feature2 = "Cd27")
FeatureScatter(NK_and_ILC1, feature1 = "Itgam", feature2 = "Cd27")

# exhaustion
exhaustion_genes1 <- c("Tcf7", "Pdcd1", "Tox", "Tigit", "Havcr2", "Slamf6", "Cxcr5", "Nfatc1", "Nfatc2") 
exhaustion_genes2 <- c("Nfatc3", "Nfatc4", "Nfat5", "Nr4a1", "Nr4a2", "Nr4a3", "Lag3", "Ctla4", "Prdm1")  
exhaustion_genes <- c("Tcf7", "Pdcd1", "Tox", "Tigit", "Havcr2", "Slamf6", "Cxcr5", "Nfatc1", "Nfatc2", "Nfatc3", "Nfat5", "Nr4a1", "Nr4a2", "Nr4a3", "Lag3", "Ctla4", "Prdm1")

FeaturePlot(NK_and_ILC1, features = exhaustion_genes1, min.cutoff = 'q10', reduction = "umap", split.by = "NK_ILC1_clusters")
VlnPlot(NK_and_ILC1, features = exhaustion_genes1, group.by = "NK_ILC1_clusters", pt.size = 0)
FeaturePlot(NK_and_ILC1, features = exhaustion_genes2, min.cutoff = 'q10', reduction = "umap", split.by = "NK_ILC1_clusters")
VlnPlot(NK_and_ILC1, features = exhaustion_genes2, group.by = "NK_ILC1_clusters", pt.size = 0)

DotPlot(NK_and_ILC1, features = exhaustion_genes1, group.by = "NK_ILC1_clusters", split.by = "organoid", cols = c("lightblue", "pink")) + RotatedAxis()

DotPlot(NK_and_ILC1, features = exhaustion_genes2, group.by = "NK_ILC1_clusters", split.by = "organoid", cols = c("lightblue", "pink")) + RotatedAxis()

NK_and_ILC1 <- AddModuleScore(
  NK_and_ILC1,
  exhaustion_genes,
  pool = NULL,
  nbin = 24,
  ctrl = 100,
  k = FALSE,
  assay = NULL,
  name = "Exhaustion_sig",
  seed = 1,
  search = FALSE,
  slot = "data"
)
VlnPlot(NK_and_ILC1, features = "Exhaustion_sig1", split.by = "organoid", group.by = "NK_ILC1_clusters")
```

# Cytokines, markers (from literature), DE between organoids (general)

```{r cytokines, echo = TRUE}
cytokine_ligands <- c("Ifng", "Tnf", "Il2", "Il10", "Il12a", "Il18", "Il1b", "Il15")
cytokine_receptors <- c("Il2rb", "Il2rg", "Il10ra", "Il10rb", "Il12rb1", "Il12rb2", "Il18r1", "Il1r1", "Il15ra", "Klrd1", "Ncr1", "Klrc2", "Klrb1c", "Klre1", "Klra7")

DotPlot(NK_and_ILC1, features = cytokine_ligands, group.by = "NK_ILC1_clusters", split.by = "organoid") + RotatedAxis()
DotPlot(NK_and_ILC1, features = cytokine_receptors, group.by = "NK_ILC1_clusters", split.by = "organoid") + RotatedAxis()

#ILC1 markers -> Tbx21, Ifng, Il7r, Cxcr6, Gzma, Cxcr3, Cd49a, Cd69, Il2ra, Tnfsf10 (TRAIL), Cd73
# NK markers -> Eomes, Nkg7, Gzmb, Prf1, Klrb1c, Klrc1
marker_genes <- c("Tbx21", "Ifng", "Eomes", "Nkg7", "Gzmb", "Klrb1c", "Prf1", "Gzma", "Il7r", "Cxcr6", "Cxcr3", "Cd49a", "Cd69", "Il2ra", "Tnfsf10", "Ctsw", "Txk", "Cd7")
DotPlot(NK_and_ILC1, features = marker_genes, group.by = "NK_ILC1_clusters", split.by = "organoid") + RotatedAxis()

#DEGs by organoids
Idents(NK_and_ILC1) <- "organoid"
organoid_DEGs <- FindMarkers(NK_and_ILC1, ident.1 = "m95", ident.2 = "m96", logfc.threshold = 0.2, min.pct = 0.25) 
head(organoid_DEGs[order(organoid_DEGs$p_val_adj), ])

organoid_DEGs %>%
  filter(p_val_adj < 0.05 & abs(avg_log2FC) > 0.2) %>%
  arrange(desc(abs(avg_log2FC))) %>%
  head(20)

top_deg <- rownames(organoid_DEGs %>% top_n(10, wt = abs(avg_log2FC)))
DoHeatmap(NK_and_ILC1, features = top_deg, group.by = "organoid") + ggtitle("Top DEGs between m95 and m96")

symbols <- symbols[match(rownames(organoid_DEGs), names(symbols))]
rownames(organoid_DEGs) <- symbols
keep <- !is.na(rownames(organoid_DEGs))
organoid_DEGs <- organoid_DEGs[keep,]

EnhancedVolcano(organoid_DEGs,
    lab = rownames(organoid_DEGs),
    x = 'avg_log2FC',
    y = 'p_val_adj',
    title = 'm95 vs m96',
    pCutoff = 0.05,
    FCcutoff = 0.2)

```

## DEGs between organoids for each cluster

``` {r degs, echo = TRUE}

Idents(NK_and_ILC1) <- "NK_ILC1_clusters"
de_results_list <- list()

for (cluster_id in 0:5) {
  message(paste("Processing cluster", cluster_id))

  cluster_cells <- subset(NK_and_ILC1, idents = as.character(cluster_id))
  cluster_cells$organoid <- factor(cluster_cells$organoid)
  Idents(cluster_cells) <- "organoid"

  de_res <- FindMarkers(
    cluster_cells,
    ident.1 = "m95",
    ident.2 = "m96",
    test.use = "DESeq2",
    logfc.threshold = 0.2
  )

  de_results_list[[paste0("cluster", cluster_id)]] <- de_res

  top_genes <- rownames(de_res)[1:10]

  print(
    VlnPlot(cluster_cells, features = top_genes, split.by = "organoid", pt.size = 0) +
    ggtitle(paste("Cluster", cluster_id, "- Top DE Genes"))
  )

  print(
    DoHeatmap(cluster_cells, features = top_genes, group.by = "organoid") +
    ggtitle(paste("Cluster", cluster_id, "- Top DE Genes Heatmap"))
  )

  print(
    EnhancedVolcano(
      de_res,
      lab = rownames(de_res),
      x = "avg_log2FC",
      y = "p_val", # if using adjusted, nothing significant is shown (except c4)
      pCutoff = 0.05,
      FCcutoff = 0.2,
      title = paste("Volcano Plot - Cluster", cluster_id),
      subtitle = "DESeq2: m95 vs m96",
      pointSize = 2.5,
      labSize = 3.5
    )
  )
  
  print(
  DotPlot(cluster_cells, features = top_genes, 
          group.by = "NK_ILC1_clusters", split.by = "organoid") +
    RotatedAxis() +
    ggtitle(paste("DotPlot - Top DEGs in Cluster", cluster_id))
  )
}

```

## GSEA (for DEGs across organoids for each cluster); nothing comes up except for 1 pathway in c5

``` {r degs_gsea, echo = TRUE}
library(clusterProfiler)
library(org.Mm.eg.db)
organism <- org.Mm.eg.db

gsea_results_list <- list()

for (cluster_name in names(de_results_list)) {
  message(paste("Running GSEA for", cluster_name))
  
  de_res <- de_results_list[[cluster_name]]
  
  ranked_genes <- de_res$avg_log2FC
  names(ranked_genes) <- rownames(de_res)
  ranked_genes <- sort(ranked_genes, decreasing = TRUE)
  
  gsea_res <- tryCatch({
    gseGO(
      geneList = ranked_genes,
      OrgDb = organism,
      keyType = "SYMBOL",
      ont = "ALL",
      pAdjustMethod = "BH",
      pvalueCutoff = 0.05,
      verbose = FALSE
    )
  }, error = function(e) {
    message(paste("No enrichments for", cluster_name, "- skipping."))
    return(NULL)
  })
  
  if (!is.null(gsea_res) && nrow(gsea_res@result) > 0) {
    gsea_results_list[[cluster_name]] <- gsea_res
    
    print(dotplot(gsea_res, showCategory = 20) + ggtitle(paste("GSEA -", cluster_name)))
    
    top5 <- head(gsea_res@result[order(gsea_res@result$p.adjust), ], 5)
    top5_ids <- match(top5$ID, gsea_res@result$ID)
    print(gseaplot2(gsea_res, geneSetID = top5_ids, title = paste("Top 5 Pathways -", cluster_name)))
  } else {
    message(paste("No significant pathways found for", cluster_name))
  }
}
```
